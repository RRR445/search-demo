<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Search Settings Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#121318; --muted:#8a8fa0; --accent:#4ad295; --border:#1c2130; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:#e8ebf1; }
    .container { max-width:980px; margin: 24px auto; padding: 0 16px; }
    h1 { margin:0 0 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .row { display:flex; align-items:center; gap:12px; margin: 8px 0; }
    label { width:240px; color:#cfd3df; }
    input[type="range"] { flex:1; }
    input[type="number"], input[type="text"] { width:220px; padding:8px; border-radius:8px; border:1px solid #2a2f3a; background:#0f1116; color:#e8ebf1; }
    textarea { width:100%; min-height:140px; padding:10px; border-radius:8px; border:1px solid #2a2f3a; background:#0f1116; color:#e8ebf1; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .actions { display:flex; gap:10px; margin-top:12px; }
    button { border-radius:10px; padding:10px 12px; border:1px solid #2a2f3a; background:#0f1116; color:#e8ebf1; cursor:pointer; }
    .ok { color:#9ae6b4; }
    .muted { color:var(--muted); }
    .note { font-size:.9rem; color:var(--muted); }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px) { .split { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öôÔ∏è Haku¬≠painotusten & kenttien hallinta</h1>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Weights</h3>
        <div class="row">
          <label>Rating (0..5) kerroin</label>
          <input id="rating" type="range" min="0" max="2" step="0.05">
          <input id="ratingNum" type="number" step="0.05">
        </div>
        <div class="row">
          <label>Arvostelujen paino (log1p)</label>
          <input id="reviews" type="range" min="0" max="2" step="0.05">
          <input id="reviewsNum" type="number" step="0.05">
        </div>
        <div class="row">
          <label>Myynti 30d paino (log1p)</label>
          <input id="sales" type="range" min="0" max="3" step="0.1">
          <input id="salesNum" type="number" step="0.1">
        </div>
        <div class="row">
          <label>Varastosaatavuus bonus</label>
          <input id="stock" type="range" min="1" max="3" step="0.1">
          <input id="stockNum" type="number" step="0.1">
        </div>
        <div class="row">
          <label>Uutuuden vaikutus (p√§iv√§√§)</label>
          <input id="decay" type="range" min="7" max="120" step="1">
          <input id="decayNum" type="number" step="1">
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Field names</h3>
        <div class="row"><label>Rating field</label><input id="rating_field" type="text" placeholder="rating"></div>
        <div class="row"><label>Reviews field</label><input id="reviews_field" type="text" placeholder="reviews"></div>
        <div class="row"><label>Sales (30d) field</label><input id="sales30_field" type="text" placeholder="sales_30d"></div>
        <div class="row"><label>Added-at (date) field</label><input id="added_at_field" type="text" placeholder="added_at"></div>
        <div class="row"><label>Brand field</label><input id="brand_field" type="text" placeholder="brand"></div>
        <div class="row"><label>Category field</label><input id="category_field" type="text" placeholder="category_path"></div>
        <div class="row"><label>In-stock field (bool)</label><input id="in_stock_field" type="text" placeholder="in_stock"></div>
        <div class="row"><label>Price field</label><input id="price_field" type="text" placeholder="price"></div>
        <div class="row"><label>Image field</label><input id="image_field" type="text" placeholder="image"></div>
        <div class="row"><label>Image URL field</label><input id="image_url_field" type="text" placeholder="image_url"></div>
        <div class="note">Sy√∂t√§ t√§sm√§lleen teid√§n indeksin kenttien nimet. Tyhj√§ = ei k√§ytet√§.</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Brand boosts (JSON)</h3>
        <textarea id="brandBoosts" placeholder='{"purelux":1.2,"autodude":1.1}'></textarea>
      </div>

      <div class="card">
        <div class="actions">
          <button id="saveBtn">üíæ Tallenna</button>
          <button id="reloadBtn">üîÑ Lataa</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div class="card">
        <div class="split">
          <div>
            <div class="row">
              <label>Testikysely</label>
              <input id="q" type="text" placeholder="esim. vaha, painepesuri">
            </div>
            <div class="actions">
              <button id="testBtn">üîç Suorita testi</button>
              <span class="muted">Tulostaa top 5 nimen & scoret</span>
            </div>
          </div>
          <pre id="out" style="margin:0;white-space:pre-wrap;background:#0f1116;border:1px solid #2a2f3a;padding:10px;border-radius:8px;"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = location.origin;

    const W = ["rating","reviews","sales","stock","decay"];
    const F = ["rating_field","reviews_field","sales30_field","added_at_field","brand_field","category_field","in_stock_field","price_field","image_field","image_url_field"];

    const els = {};
    for (const id of ["rating","reviews","sales","stock","decay","ratingNum","reviewsNum","salesNum","stockNum","decayNum","brandBoosts","saveBtn","reloadBtn","q","testBtn","out","status", ...F]) {
      els[id] = document.getElementById(id) || (document.getElementById(id) ?? null);
    }

    function bind(a, b){
      a.addEventListener('input', ()=> b.value = a.value);
      b.addEventListener('input', ()=> a.value = b.value);
    }
    bind(els.rating, els.ratingNum);
    bind(els.reviews, els.reviewsNum);
    bind(els.sales, els.salesNum);
    bind(els.stock, els.stockNum);
    bind(els.decay, els.decayNum);

    async function loadSettings(){
      els.status.textContent = 'Ladataan‚Ä¶';
      const r = await fetch(`${API}/settings`);
      const s = await r.json();

      // weights
      els.rating.value = els.ratingNum.value = s.weights.rating ?? 0.4;
      els.reviews.value = els.reviewsNum.value = s.weights.reviews ?? 0.2;
      els.sales.value = els.salesNum.value = s.weights.sales_30d ?? 0.8;
      els.stock.value = els.stockNum.value = s.weights.in_stock_bonus ?? 1.3;
      els.decay.value = els.decayNum.value = s.weights.newness_decay_days ?? 45;

      // brand boosts
      els.brandBoosts.value = JSON.stringify(s.brand_boosts ?? {}, null, 2);

      // field names
      for (const k of F) {
        els[k].value = (s.field_names && s.field_names[k]) ? s.field_names[k] : "";
      }

      els.status.textContent = '';
    }

    async function saveSettings(){
      els.status.textContent = 'Tallennetaan‚Ä¶';
      let boosts = {};
      try { boosts = JSON.parse(els.brandBoosts.value || '{}'); }
      catch(e){ alert('Brandiboostien JSON ei kelpaa'); return; }

      const payload = {
        weights: {
          rating: parseFloat(els.rating.value),
          reviews: parseFloat(els.reviews.value),
          sales_30d: parseFloat(els.sales.value),
          in_stock_bonus: parseFloat(els.stock.value),
          newness_decay_days: parseInt(els.decay.value, 10)
        },
        brand_boosts: boosts,
        field_names: Object.fromEntries(F.map(k => [k, (els[k].value || null)]))
      };

      const r = await fetch(`${API}/settings`, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!r.ok){ els.status.textContent = 'Virhe tallennuksessa'; return; }
      els.status.textContent = '‚úÖ Tallennettu';
      setTimeout(()=> els.status.textContent = '', 1500);
    }

    async function testSearch(){
      const q = els.q.value.trim();
      const url = `${API}/search?` + new URLSearchParams({ q, size: 5 });
      const r = await fetch(url);
      const data = await r.json();
      const lines = (data.hits || []).map(h => `${(h._score??'').toFixed ? h._score.toFixed(2) : h._score}  |  ${h.name}  ${h.brand?`(${h.brand})`:''}`);
      els.out.textContent = lines.join('\n') || 'Ei tuloksia.';
    }

    els.reloadBtn.addEventListener('click', loadSettings);
    els.saveBtn.addEventListener('click', saveSettings);
    els.testBtn.addEventListener('click', testSearch);

    loadSettings();
  </script>
</body>
</html>
